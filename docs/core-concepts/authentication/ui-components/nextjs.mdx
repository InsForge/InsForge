---
title: Next.js
description: Zero-configuration authentication for Next.js with built-in UI components
---

The `@insforge/nextjs` package provides **zero-configuration authentication** for Next.js applications. Authentication pages are hosted on your backend by default—no UI code needed.

## Why Built-in Auth?

<CardGroup cols={2}>
  <Card title="Zero UI Code" icon="code">
    No SignIn/SignUp pages to create
  </Card>
  
  <Card title="5-Minute Setup" icon="clock">
    Provider + API route + callback page = done
  </Card>
  
  <Card title="Production Ready" icon="shield-check">
    Battle-tested auth UI maintained by Insforge
  </Card>
  
  <Card title="Auto OAuth" icon="key">
    11 providers configured automatically from backend
  </Card>
</CardGroup>

<Note>
Use custom components only if you need highly customized branding or custom fields.
</Note>

## Features

- **Built-in Authentication**: Backend-hosted sign-in/sign-up pages (default)
- **OAuth Support**: Google, GitHub, Discord, Facebook, LinkedIn, Microsoft, Apple, X, Instagram, TikTok, Spotify
- **React Hooks**: `useAuth()`, `useUser()`, `useSession()`
- **Control Components**: `<SignedIn>`, `<SignedOut>`, `<Protect>`
- **Next.js Middleware**: Server-side route protection
- **TypeScript**: Full type safety

## Installation

```bash
npm install @insforge/nextjs @insforge/sdk
```

<Note>
**SDK Integration**: `@insforge/nextjs` works seamlessly with `@insforge/sdk`. The SDK handles API calls, token management, and OAuth callback detection automatically. Always use SDK methods instead of raw `fetch` calls.
</Note>

## Quick Start (Built-in Auth)

### Step 1: Add InsforgeProvider

Wrap your application with the `InsforgeProvider` in your root layout:

```tsx app/layout.tsx
import { InsforgeProvider } from '@insforge/nextjs';

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body>
        <InsforgeProvider baseUrl={process.env.NEXT_PUBLIC_INSFORGE_BASE_URL!}>
          {children}
        </InsforgeProvider>
      </body>
    </html>
  );
}
```

### Step 2: Create API Route

Create an API route to enable server-side rendering (SSR) and cookie-based authentication:

```tsx app/api/auth/route.ts
import { createAuthRouteHandlers } from '@insforge/nextjs/api';

const handlers = createAuthRouteHandlers({
  baseUrl: process.env.INSFORGE_BASE_URL || process.env.NEXT_PUBLIC_INSFORGE_BASE_URL!,
  cookieName: 'insforge_token',
});

export const POST = handlers.POST;
export const GET = handlers.GET;
export const DELETE = handlers.DELETE;
```

<Info>
**Why?** This route syncs auth tokens to HTTP-only cookies for server-side middleware.
</Info>

### Step 3: Create Callback Page

<Warning>
**Critical:** The callback page is essential for authentication to work. It receives tokens from backend auth pages (both OAuth and email/password flows) and stores them properly.
</Warning>

Create a callback page that receives authentication data from backend auth pages:

**What Backend Returns:**
After successful authentication (OAuth or email/password), backend redirects to your callback URL with these query parameters:
- `access_token` - JWT token (required)
- `user_id` - User ID (required)
- `email` - User email (required)
- `name` - User name (optional)
- `error` - Error message (if authentication failed)

**Complete Callback Implementation (SDK-powered):**

<Warning>
**Always use SDK**: The SDK automatically detects and handles URL parameters. Do not manually parse URL parameters or store tokens. The SDK handles this automatically when you create a client.
</Warning>

```tsx app/auth/callback/page.tsx
'use client';

import { useEffect, useRef, Suspense } from 'react';
import { useRouter, useSearchParams } from 'next/navigation';
import { createClient } from '@insforge/sdk';

function CallbackContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const isProcessingRef = useRef(false);

  useEffect(() => {
    const processCallback = async () => {
      if (isProcessingRef.current) return;
      isProcessingRef.current = true;

      const error = searchParams.get('error');
      if (error) {
        router.push('/?error=' + encodeURIComponent(error));
        return;
      }

      // Step 1: Create SDK client - it automatically detects and stores URL parameters
      // SDK's detectOAuthCallback() automatically handles: access_token, user_id, email, name
      // This stores token in 'insforge-auth-token' and basic user in 'insforge-auth-user'
      const insforge = createClient({
        baseUrl: process.env.NEXT_PUBLIC_INSFORGE_BASE_URL!,
      });

      // Step 2: Fetch complete user data (including profile) using SDK method
      // SDK ensures consistency and proper error handling
      const { data: userData, error: userError } = await insforge.auth.getCurrentUser();

      if (userError || !userData) {
        router.push('/?error=authentication_failed');
        return;
      }

      // Step 3: Store complete user profile for InsforgeProvider (enables instant UI updates)
      localStorage.setItem('insforge-user-profile', JSON.stringify(userData));

      // Step 4: Sync token to HTTP-only cookie (for server-side middleware)
      const token = localStorage.getItem('insforge-auth-token');
      if (token) {
        await fetch('/api/auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'sync-token', token }),
        });
      }

      // Step 5: Clean up URL and redirect
      window.history.replaceState({}, '', '/auth/callback');
      const destination = sessionStorage.getItem('auth_destination') || '/';
      sessionStorage.removeItem('auth_destination');
      setTimeout(() => router.push(destination), 100);
    };

    processCallback();
  }, [searchParams, router]);

  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="text-center">
        <h2 className="text-2xl font-semibold mb-4">Completing authentication...</h2>
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
      </div>
    </div>
  );
}

export default function CallbackPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <CallbackContent />
    </Suspense>
  );
}
```

<Info>
**Why SDK Integration Matters:**
- **Automatic Detection**: SDK automatically detects URL parameters (`access_token`, `user_id`, `email`, `name`) and stores them
- **Consistent Storage**: SDK handles token storage (`insforge-auth-token`) and basic user info (`insforge-auth-user`) automatically
- **Type Safety**: SDK methods ensure type-safe API calls with proper error handling
- **User Profile**: Use SDK's `getCurrentUser()` to fetch complete user data including profile fields
- **Error Reduction**: Using SDK methods reduces manual errors compared to raw `fetch` calls

**For AI Agents:** Always use SDK methods (`createClient()`, `getCurrentUser()`) instead of manually parsing URL parameters or making raw API calls. The SDK handles OAuth callback detection, token storage, and API communication automatically.
</Info>

### Step 4: Add Middleware

Create middleware to protect routes:

```ts middleware.ts
import { InsforgeMiddleware } from '@insforge/nextjs/middleware';

export default InsforgeMiddleware({
  baseUrl: process.env.INSFORGE_BASE_URL!,
  publicRoutes: ['/auth/callback', '/'],
  cookieName: 'insforge_token',
});

export const config = {
  matcher: ['/((?!api|_next/static|_next/image|favicon.ico|.*\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)'],
};
```

### Step 5: Use in Components

Use the provided components and hooks in your pages:

```tsx app/page.tsx
import { SignedIn, SignedOut, UserButton } from '@insforge/nextjs';

export default function Home() {
  return (
    <div>
      <SignedOut>
        <a href="/sign-in">Sign In</a>
      </SignedOut>

      <SignedIn>
        <UserButton afterSignOutUrl="/" />
        <h1>Welcome back!</h1>
      </SignedIn>
    </div>
  );
}
```

**That's it!** When users click "Sign In", they'll be redirected to your backend's auth page automatically.

## How It Works

### Authentication Flow (Unified for OAuth and Email/Password)

```
1. User clicks "Sign In" → Middleware detects no auth
   ↓
2. Redirects to: https://backend.insforge.app/auth/signin?redirect=yourapp.com/auth/callback
   ↓
3. User authenticates on backend's hosted page
   - Option A: OAuth (Google, GitHub, etc.)
   - Option B: Email + Password
   ↓
4. Backend processes authentication and redirects:
   yourapp.com/auth/callback?access_token=xxx&user_id=xxx&email=xxx&name=xxx
   ↓
5. Callback page processes:
   - Stores token in localStorage (client-side SDK)
   - Stores user profile in localStorage (instant UI)
   - Syncs token to HTTP-only cookie (server-side middleware)
   - Cleans URL (removes sensitive data)
   ↓
6. Redirects to destination → User sees /dashboard
```

<Note>
**Why API route + callback?**
- **API route** (`/api/auth`): Syncs tokens to HTTP-only cookies (enables server-side middleware protection)
- **Callback page** (`/auth/callback`): Receives tokens and user data from backend auth pages (OAuth + email/password), stores them properly, and handles redirect

**Unified Format:** Both OAuth and email/password flows return the same parameters, making the callback page simple and consistent.
</Note>

## Local Development

Backend typically runs on different port during local development:

```bash .env.local
NEXT_PUBLIC_INSFORGE_BASE_URL=http://localhost:7130       # Backend API
NEXT_PUBLIC_INSFORGE_FRONTEND_URL=http://localhost:7131   # Backend Frontend (auth pages)
INSFORGE_BASE_URL=http://localhost:7130                   # For middleware
```

<Info>
The provider automatically uses `NEXT_PUBLIC_INSFORGE_FRONTEND_URL` for auth redirects if set.
</Info>

## SDK + Next.js Package Integration

<Note>
**Important**: `@insforge/nextjs` works seamlessly with `@insforge/sdk`. The SDK handles all API calls, token management, and OAuth callback detection. Always use SDK methods instead of raw `fetch` calls.
</Note>

**What SDK handles:**
- API calls to backend (`getCurrentUser()`, `signIn()`, `signUp()`, etc.)
- Token storage and management (`insforge-auth-token`, `insforge-auth-user`)
- OAuth callback parameter detection (automatic on `createClient()`)
- Type-safe responses with proper error handling

**What Next.js package handles:**
- React components (`<SignedIn>`, `<SignedOut>`, `<Protect>`, `<UserButton>`)
- React hooks (`useAuth()`, `useUser()`, `useSession()`)
- Next.js middleware for route protection
- SSR support via cookie sync

## React Hooks

### useAuth()

Access authentication state and methods (wraps SDK methods):

```tsx
import { useAuth } from '@insforge/nextjs';

function Component() {
  const { signIn, signUp, signOut, isSignedIn, isLoaded } = useAuth();
  
  async function handleSignIn(email: string, password: string) {
    try {
      await signIn(email, password); // Uses SDK internally
    } catch (error) {
      console.error('Sign in failed:', error);
    }
  }
  
  return (
    <div>
      {isSignedIn && <button onClick={() => signOut()}>Sign Out</button>}
    </div>
  );
}
```

**Returns**: `signIn()`, `signUp()`, `signOut()`, `isLoaded`, `isSignedIn`

### useUser()

Access current user data (from SDK-managed storage):

```tsx
import { useUser } from '@insforge/nextjs';

function UserProfile() {
  const { user, isLoaded, updateUser } = useUser();
  
  if (!isLoaded) return <div>Loading...</div>;
  if (!user) return <div>Not signed in</div>;
  
  return (
    <div>
      <p>Email: {user.email}</p>
      {user.nickname && <p>Nickname: {user.nickname}</p>}
    </div>
  );
}
```

**Returns**: `user`, `isLoaded`, `updateUser()`

### useSession()

Access session data (from SDK-managed storage):

```tsx
import { useSession } from '@insforge/nextjs';

function SessionInfo() {
  const { session, isLoaded } = useSession();
  
  if (!isLoaded) return <div>Loading...</div>;
  if (!session) return <div>No active session</div>;
  
  return <div>User ID: {session.userId}</div>;
}
```

**Returns**: `session`, `isLoaded`

## Control Components

### SignedIn / SignedOut

Conditionally render content based on authentication state:

```tsx
import { SignedIn, SignedOut } from '@insforge/nextjs';

function NavBar() {
  return (
    <nav>
      <SignedOut>
        <a href="/sign-in">Sign In</a>
      </SignedOut>

      <SignedIn>
        <UserButton />
      </SignedIn>
    </nav>
  );
}
```

### Protect

Conditionally render content based on custom conditions:

```tsx
import { Protect } from '@insforge/nextjs';

function AdminPanel() {
  return (
    <Protect condition={(user) => user.role === 'admin'}>
      <div>Admin Dashboard</div>
    </Protect>
  );
}
```

### UserButton

Pre-built user menu with sign-out functionality:

```tsx
import { UserButton } from '@insforge/nextjs';

function Header() {
  return (
    <header>
      <UserButton 
        afterSignOutUrl="/" 
        showEmail={true} 
      />
    </header>
  );
}
```

## Server-Side Helpers

Access authentication data in Server Components (uses middleware headers):

```tsx app/dashboard/page.tsx
import { headers } from 'next/headers';
import { getAuthUserId, getAuthToken } from '@insforge/nextjs/middleware';
import { createClient } from '@insforge/sdk';

export default async function Dashboard() {
  const userId = getAuthUserId(headers());
  const token = getAuthToken(headers());
  
  if (!userId) {
    return <div>Not authenticated</div>;
  }
  
  // Use SDK to fetch user data server-side
  const insforge = createClient({
    baseUrl: process.env.INSFORGE_BASE_URL!,
    edgeFunctionToken: token || undefined,
  });
  
  const { data: userData } = await insforge.auth.getCurrentUser();
  
  return <div>Welcome, {userData?.user.email}</div>;
}
```

<Note>
For server-side data fetching, use SDK with the token from middleware headers. This ensures consistent API access patterns.
</Note>

## Why @insforge/nextjs + SDK?

<CardGroup cols={2}>
  <Card title="For Developers" icon="user">
    5-minute auth setup instead of hours. SDK handles API calls automatically. Production-ready security included.
  </Card>
  
  <Card title="For AI Agents" icon="robot">
    SDK-first approach reduces errors. Minimal code generation (5 files vs 20+). Always use SDK methods instead of raw `fetch` calls.
  </Card>
</CardGroup>

<Note>
**Key Principle**: Always use SDK methods (`insforge.auth.getCurrentUser()`, `insforge.auth.signIn()`, etc.) instead of raw `fetch` calls. The SDK ensures consistency, type safety, and automatic error handling. The Next.js package provides React components and hooks that work seamlessly with the SDK.
</Note>

## Resources

<CardGroup cols={3}>
  <Card title="Documentation" icon="book" href="https://docs.insforge.dev/introduction">
    Full documentation
  </Card>
  
  <Card title="GitHub Issues" icon="github" href="https://github.com/InsForge/InsForge/issues">
    Report bugs & request features
  </Card>
  
  <Card title="Discord Community" icon="discord" href="https://discord.com/invite/DvBtaEc9Jz">
    Get help & share feedback
  </Card>
</CardGroup>

